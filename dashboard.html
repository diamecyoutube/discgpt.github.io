<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>discGPT | Neural Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .glass { background: rgba(15, 17, 23, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.05); }
        .input-dark { background: #1a1d24; border: 1px solid rgba(255,255,255,0.08); transition: all 0.2s; }
        .input-dark:focus { border-color: #6366f1; box-shadow: 0 0 10px rgba(99, 102, 241, 0.2); }
        .category-tab.active { background: #6366f1; color: white; border-color: #6366f1; }
        .premium-text { background: linear-gradient(90deg, #818cf8, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; }
        .unlimited-text { background: linear-gradient(90deg, #f472b6, #fbbf24); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; }
        .ai-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-[#050608] text-gray-200 min-h-screen">

    <!-- LOGIN -->
    <div id="loginPage" class="flex items-center justify-center min-h-screen p-6">
        <div class="glass p-10 rounded-3xl shadow-2xl w-full max-w-md border-indigo-500/20 border text-center">
            <h2 class="text-4xl font-black mb-1 italic text-indigo-500">discGPT</h2>
            <p class="text-[9px] text-gray-500 mb-8 uppercase tracking-[0.4em]">Neural Interface v3.0</p>
            <div class="space-y-4 text-left">
                <label class="text-[10px] font-bold text-gray-600 uppercase tracking-widest ml-1">Access Credentials</label>
                <input type="password" id="keyInput" placeholder="•••• •••• ••••" class="w-full input-dark p-4 rounded-xl text-center font-mono tracking-widest outline-none">
                <button onclick="login()" id="loginBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 py-4 rounded-xl font-black transition-all active:scale-95 shadow-lg shadow-indigo-600/20">INITIATE NEURAL LINK</button>
            </div>
            <div id="loginError" class="mt-4 p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-xs text-red-400 hidden"></div>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="dashPage" class="hidden p-4 md:p-8 lg:p-12 max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
            <div>
                <h1 id="userLabel" class="text-3xl font-black uppercase italic tracking-tighter text-white">Interface</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span class="w-2 h-2 bg-green-500 rounded-full ai-pulse"></span>
                    <p class="text-gray-500 text-[10px] font-bold uppercase tracking-widest">Neural Cluster: Active</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="openAIPlayground()" class="bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400 px-5 py-2.5 rounded-xl text-xs font-black border border-indigo-500/20 transition">NEURAL TESTBED</button>
                <button onclick="location.reload()" class="bg-white/5 hover:bg-red-500/10 text-gray-400 px-5 py-2.5 rounded-xl text-xs font-black border border-white/5 transition">DISCONNECT</button>
            </div>
        </header>

        <!-- ADMIN SECTION -->
        <section id="adminPanel" class="hidden mb-10">
            <div class="glass p-6 rounded-2xl border-red-500/20 border bg-red-500/5">
                <h3 class="text-red-500 font-black text-xs tracking-widest uppercase mb-4">Root Overrides</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="guildId" placeholder="Cluster ID (Server ID)" class="input-dark p-3 rounded-lg outline-none text-sm">
                    <select id="tierSelect" class="input-dark p-3 rounded-lg outline-none text-sm">
                        <option value="Free">Free Baseline</option>
                        <option value="Plus">discGPT Plus</option>
                        <option value="Unlimited">discGPT Unlimited</option>
                    </select>
                    <button onclick="updateGuildSettings(true)" id="adminUpdateBtn" class="bg-red-600 hover:bg-red-700 rounded-lg font-bold text-xs transition text-white">FORCE UPDATE TIER</button>
                </div>
            </div>
        </section>

        <main class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- SERVERS -->
            <aside class="space-y-4">
                <h2 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Neural Clusters</h2>
                <div id="guildList" class="space-y-2"></div>
            </aside>

            <!-- CONFIGURATION -->
            <section class="lg:col-span-3">
                <div id="settingsPlaceholder" class="glass h-[500px] flex items-center justify-center rounded-3xl border-dashed border-2 border-white/5">
                    <div class="text-center opacity-30">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mx-auto mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                        <p class="font-black italic">SELECT A CLUSTER TO CONFIGURE</p>
                    </div>
                </div>

                <div id="settingsPanel" class="hidden glass p-8 rounded-3xl space-y-8 animate-in slide-in-from-bottom duration-500">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 border-b border-white/5 pb-8">
                        <div class="flex items-center gap-4">
                            <img id="activeIcon" src="" class="w-16 h-16 rounded-2xl border border-white/10 shadow-2xl">
                            <div>
                                <h2 id="activeName" class="text-2xl font-black italic text-white">Server Name</h2>
                                <span id="activeTier" class="premium-text text-[10px] uppercase tracking-tighter">Tier</span>
                            </div>
                        </div>
                        <nav id="categoryNav" class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                            <button onclick="switchCategory('ai')" class="category-tab active px-4 py-2 rounded-xl text-[10px] font-black border border-white/5 transition whitespace-nowrap">AI CORE</button>
                            <button onclick="switchCategory('mod')" class="category-tab px-4 py-2 rounded-xl text-[10px] font-black border border-white/5 transition whitespace-nowrap">SECURITY</button>
                            <button onclick="switchCategory('unlim')" class="category-tab px-4 py-2 rounded-xl text-[10px] font-black border border-white/5 transition whitespace-nowrap">UNLIMITED ONLY</button>
                            <button onclick="switchCategory('sub')" class="category-tab px-4 py-2 rounded-xl text-[10px] font-black border border-white/5 transition whitespace-nowrap">SUBSCRIPTION</button>
                        </nav>
                    </div>

                    <div id="categoryContent" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>

                    <div class="pt-8 border-t border-white/5 flex flex-col md:flex-row items-center gap-4">
                        <button onclick="updateGuildSettings(false)" id="saveBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 py-4 rounded-xl font-black shadow-lg shadow-indigo-600/20 transition-all active:scale-95">SAVE NEURAL CONFIG</button>
                        <p id="saveStatus" class="text-xs font-bold whitespace-nowrap"></p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- AI PLAYGROUND -->
    <div id="aiModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/90 p-4">
        <div class="glass w-full max-w-2xl h-[600px] rounded-3xl flex flex-col overflow-hidden border-indigo-500/30 border">
            <div class="p-6 border-b border-white/5 flex justify-between items-center bg-indigo-600/5">
                <h3 class="font-black italic text-indigo-400">NEURAL TESTBED</h3>
                <button onclick="closeAIPlayground()" class="text-gray-500 hover:text-white">&times;</button>
            </div>
            <div id="chatBox" class="flex-1 p-6 overflow-y-auto space-y-4 text-sm font-medium">
                <div class="bg-white/5 p-4 rounded-2xl max-w-[80%]">System: Neural link active. Model: Gemini-1.5-Flash. Ready for input.</div>
            </div>
            <div class="p-4 bg-white/5 border-t border-white/5 flex gap-2">
                <input type="text" id="aiInput" placeholder="Send a neural pulse..." class="flex-1 input-dark p-4 rounded-xl outline-none" onkeypress="if(event.key==='Enter') sendAIMessage()">
                <button onclick="sendAIMessage()" id="sendBtn" class="bg-indigo-600 px-6 rounded-xl font-bold">SEND</button>
            </div>
        </div>
    </div>

    <!-- PREMIUM LOCK -->
    <div id="premiumModal" class="hidden fixed inset-0 z-[110] flex items-center justify-center bg-black/80 backdrop-blur-md p-4">
        <div class="glass p-8 rounded-3xl max-w-sm w-full text-center border-indigo-500/40 border">
            <div class="w-20 h-20 bg-indigo-600/20 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
            </div>
            <h3 class="text-2xl font-black italic mb-2">Neural Tier Restricted</h3>
            <p id="lockMsg" class="text-gray-400 text-sm mb-8 leading-relaxed">This function requires an upgraded neural tier.</p>
            <div class="space-y-3">
                <button onclick="window.open('https://discord.gg/discgpt')" class="w-full bg-indigo-600 py-4 rounded-xl font-bold">UPGRADE NOW</button>
                <button onclick="document.getElementById('premiumModal').classList.add('hidden')" class="w-full py-2 text-gray-500 text-xs font-bold uppercase tracking-widest">Dismiss</button>
            </div>
        </div>
    </div>

    <script>
        const BOT_URL = "http://fi13.bot-hosting.cloud:21187";
        const API_KEY = "bohNFcIumG0hWxp6E8l8b08nubQklL1GURibpKLtAVpUpslFzn";
        // Fixed Gemini URL to use 1.5-flash which is effectively 'latest' in the preview env
        const GEMINI_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=";
        const apiKey = ""; // Provided by env at runtime

        let curPass = "";
        let selectedGuild = null;
        let guildsData = [];
        let activeCategory = 'ai';

        const config = {
            'ai': {
                fields: [
                    { id: 'engine', label: 'Primary Engine', type: 'select', opts: ['Gemini-1.5-Flash', 'Mistral-7B', 'Llama-3'], premium: false, default: 'Gemini-1.5-Flash' },
                    { id: 'footerType', label: 'Neural Footer Style', type: 'select', opts: ['Ad (Default)', 'Disabled', 'Custom Text'], premium: true, default: 'Ad (Default)' },
                    { id: 'customFooter', label: 'Custom Footer Text', type: 'text', premium: true, default: '' },
                    { id: 'embedOnly', label: 'Force Neural Embeds', type: 'toggle', premium: false, default: true }
                ]
            },
            'mod': {
                fields: [
                    { id: 'logCh', label: 'Security Log Channel', type: 'text', premium: false, default: '' },
                    { id: 'kick', label: 'Slash /kick', type: 'toggle', premium: false, default: true },
                    { id: 'context', label: 'AI Contextual Analysis', type: 'toggle', premium: true, default: false },
                    { id: 'tox', label: 'Neural Toxicity Filter', type: 'toggle', premium: true, default: false }
                ]
            },
            'unlim': {
                fields: [
                    { id: 'voiceTranscription', label: 'Real-time Voice Transcribe', type: 'toggle', unlim: true, default: false },
                    { id: 'imageGen', label: 'Neural Image Generation', type: 'toggle', unlim: true, default: false },
                    { id: 'memory', label: 'Persistent Server Memory', type: 'toggle', unlim: true, default: false },
                    { id: 'whiteLabel', label: 'Total White Labeling', type: 'toggle', unlim: true, default: false },
                    { id: 'apiAccess', label: 'External API Neural Bridge', type: 'toggle', unlim: true, default: false }
                ]
            },
            'sub': {
                fields: [
                    { id: 'status', label: 'Current Tier Status', type: 'text', premium: false, readonly: true, default: 'Free Baseline' }
                ]
            }
        };

        function login() {
            const pass = document.getElementById('keyInput').value;
            const btn = document.getElementById('loginBtn');
            btn.innerText = "LINKING NEURONS...";
            
            fetch(`${BOT_URL}/auth?key=${API_KEY}&pass=${pass}&t=${Date.now()}`)
                .then(r => r.json())
                .then(data => {
                    if (data.type) {
                        curPass = pass;
                        document.getElementById('loginPage').classList.add('hidden');
                        document.getElementById('dashPage').classList.remove('hidden');
                        document.getElementById('userLabel').innerText = data.type === 'admin' ? "ROOT INTERFACE" : "OPERATOR INTERFACE";
                        if(data.type === 'admin') document.getElementById('adminPanel').classList.remove('hidden');
                        loadGuilds();
                    } else throw "Invalid";
                })
                .catch(() => {
                    const err = document.getElementById('loginError');
                    err.innerText = "NEURAL LINK REFUSED: UNAUTHORIZED ACCESS KEY";
                    err.classList.remove('hidden');
                    btn.innerText = "RETRY INTERFACE";
                });
        }

        async function loadGuilds() {
            const r = await fetch(`${BOT_URL}/user/guilds?key=${API_KEY}&pass=${curPass}`);
            guildsData = await r.json();
            const list = document.getElementById('guildList');
            list.innerHTML = guildsData.map(g => `
                <div onclick="selectGuild('${g.id}')" class="glass p-3 rounded-xl flex items-center gap-3 cursor-pointer hover:bg-white/10 transition border border-transparent hover:border-indigo-500/30">
                    <img src="${g.icon || 'https://cdn.discordapp.com/embed/avatars/0.png'}" class="w-8 h-8 rounded-lg">
                    <div class="flex-1 overflow-hidden">
                        <p class="text-[11px] font-black truncate text-white">${g.name}</p>
                        <p class="text-[8px] text-gray-500 uppercase tracking-widest">${g.settings.tier || 'Free'}</p>
                    </div>
                </div>
            `).join('');
        }

        function selectGuild(id) {
            selectedGuild = guildsData.find(g => g.id === id);
            document.getElementById('settingsPlaceholder').classList.add('hidden');
            document.getElementById('settingsPanel').classList.remove('hidden');
            document.getElementById('activeIcon').src = selectedGuild.icon || 'https://cdn.discordapp.com/embed/avatars/0.png';
            document.getElementById('activeName').innerText = selectedGuild.name;
            document.getElementById('activeTier').innerText = selectedGuild.settings.tier || 'Free';
            switchCategory('ai');
        }

        function switchCategory(cat) {
            activeCategory = cat;
            document.querySelectorAll('.category-tab').forEach(b => {
                b.classList.remove('active');
                if(b.innerText.toLowerCase().includes(cat.substring(0,3))) b.classList.add('active');
            });
            render();
        }

        function render() {
            const tier = selectedGuild.settings.tier || 'Free';
            const isPlus = tier === 'Plus' || tier === 'Unlimited';
            const isUnlim = tier === 'Unlimited';
            
            const container = document.getElementById('categoryContent');
            container.innerHTML = config[activeCategory].fields.map(f => {
                const lock = (f.premium && !isPlus) || (f.unlim && !isUnlim);
                const lockType = (f.unlim) ? 'UNLIMITED' : 'PLUS';
                
                return `
                    <div class="space-y-3 ${lock ? 'opacity-40 grayscale' : ''}" onclick="${lock ? `showPremiumLock('${lockType}')` : ''}">
                        <label class="text-[9px] font-black text-gray-500 uppercase tracking-widest flex items-center gap-2">
                            ${f.label} 
                            ${f.premium ? '<span class="premium-text text-[8px]">[PLUS]</span>' : ''}
                            ${f.unlim ? '<span class="unlimited-text text-[8px]">[UNLIMITED]</span>' : ''}
                        </label>
                        ${renderInput(f, lock)}
                    </div>
                `;
            }).join('');
        }

        function renderInput(f, lock) {
            const val = (selectedGuild.settings[f.id] !== undefined) ? selectedGuild.settings[f.id] : f.default;
            const attr = lock ? 'disabled' : '';
            if(f.type === 'select') return `<select id="${f.id}" ${attr} class="w-full input-dark p-3 rounded-xl text-xs font-bold">${f.opts.map(o => `<option ${val==o?'selected':''}>${o}</option>`).join('')}</select>`;
            if(f.type === 'toggle') return `<div class="bg-white/5 p-3 rounded-xl flex justify-between items-center"><span class="text-[10px] text-gray-400 font-bold uppercase">Status</span><input type="checkbox" id="${f.id}" ${val ? 'checked' : ''} ${attr} class="w-5 h-5 accent-indigo-500"></div>`;
            return `<input type="text" id="${f.id}" value="${val||''}" ${attr} class="w-full input-dark p-3 rounded-xl text-xs font-bold">`;
        }

        function showPremiumLock(tier) {
            document.getElementById('lockMsg').innerText = `This is a high-level function restricted to discGPT ${tier} clusters. Upgrade to expand your neural capacity.`;
            document.getElementById('premiumModal').classList.remove('hidden');
        }

        async function updateGuildSettings(force) {
            const gid = force ? document.getElementById('guildId').value : selectedGuild.id;
            const btn = force ? document.getElementById('adminUpdateBtn') : document.getElementById('saveBtn');
            const status = force ? null : document.getElementById('saveStatus');
            
            let s = {};
            if(force) {
                s = { tier: document.getElementById('tierSelect').value };
            } else {
                Object.values(config).forEach(c => c.fields.forEach(f => {
                    const el = document.getElementById(f.id);
                    if(el) s[f.id] = f.type==='toggle' ? el.checked : el.value;
                    else s[f.id] = selectedGuild.settings[f.id];
                }));
            }

            btn.disabled = true;
            if(status) status.innerText = "UPLOADING CONFIG...";
            
            const r = await fetch(`${BOT_URL}/guild/update?key=${API_KEY}&pass=${curPass}&guild_id=${gid}&settings=${encodeURIComponent(JSON.stringify(s))}`);
            const data = await r.json();
            if(data.success) {
                if(status) { status.innerText = "NEURAL SYNC COMPLETE"; status.className = "text-green-500 font-black text-xs"; }
                loadGuilds();
            }
            btn.disabled = false;
        }

        // AI LOGIC
        function openAIPlayground() { document.getElementById('aiModal').classList.remove('hidden'); }
        function closeAIPlayground() { document.getElementById('aiModal').classList.add('hidden'); }

        async function callGemini(prompt) {
            let retries = 0;
            const maxRetries = 5;
            while(retries < maxRetries) {
                try {
                    const response = await fetch(`${GEMINI_URL}${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: "You are discGPT, a professional Discord Neural AI. Be concise and technical." }] }
                        })
                    });
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Neural Null Error: No output detected.";
                } catch (e) {
                    retries++;
                    await new Promise(r => setTimeout(r, Math.pow(2, retries) * 1000));
                }
            }
            return "Neural Link Failure: Critical API Timeout.";
        }

        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const chat = document.getElementById('chatBox');
            if(!input.value.trim()) return;

            chat.innerHTML += `<div class="bg-indigo-600/10 p-4 rounded-2xl ml-auto max-w-[80%] text-right border border-indigo-500/20">Operator: ${input.value}</div>`;
            const text = input.value;
            input.value = "";
            chat.scrollTop = chat.scrollHeight;

            const loader = document.createElement('div');
            loader.className = "text-gray-500 italic text-[10px] uppercase tracking-widest p-2";
            loader.innerText = "Processing Neural Input...";
            chat.appendChild(loader);

            const reply = await callGemini(text);
            chat.removeChild(loader);
            chat.innerHTML += `<div class="bg-white/5 p-4 rounded-2xl max-w-[80%] border border-white/5">discGPT: ${reply}</div>`;
            chat.scrollTop = chat.scrollHeight;
        }
    </script>
</body>
</html>
