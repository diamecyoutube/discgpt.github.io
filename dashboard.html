<?php
session_start();
// UPDATE THESE FOR YOUR HOSTING
$BOT_URL = "http://YOUR_BOT_IP:21187"; 
$WEB_API_KEY = "bohNFcIumG0hWxp6E8l8b08nubQklL1GURibpKLtAVpUpslFzn";

if (isset($_GET['logout'])) { session_destroy(); header("Location: dashboard.php"); exit; }
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>discGPT | Neural Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Fira Code', monospace; background: #050505; color: #00ff41; }
        .terminal-border { border: 1px solid #00ff41; }
        .log-DELETE { color: #ff3e3e; background: rgba(255,0,0,0.1); border-left: 2px solid #ff3e3e; padding-left: 5px; }
        .cursor { display: inline-block; width: 8px; height: 18px; background: #00ff41; animation: blink 1s infinite; vertical-align: middle; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body class="p-4">

<?php if (!isset($_SESSION['user'])): ?>
    <div class="flex items-center justify-center min-h-screen">
        <div class="terminal-border p-8 bg-black w-96 text-center">
            <h1 class="text-2xl mb-6 font-bold uppercase tracking-widest">> AUTH_REQUIRED</h1>
            <input type="password" id="passIn" class="w-full bg-black border border-[#00ff41] p-3 mb-4 outline-none text-center">
            <button onclick="login()" class="w-full bg-[#00ff41] text-black font-bold py-3 hover:bg-white transition">CONNECT</button>
        </div>
    </div>
    <script>
        async function login() {
            const p = document.getElementById('passIn').value;
            const res = await fetch(`<?= $BOT_URL ?>/auth?key=<?= $WEB_API_KEY ?>&pass=${p}`);
            const data = await res.json();
            if (data.type) {
                const fd = new FormData(); fd.append('type', data.type); fd.append('username', data.username); fd.append('pass', p);
                await fetch('sync.php', { method: 'POST', body: fd });
                window.location.reload();
            } else alert("Invalid Fragment");
        }
    </script>
<?php else: ?>
    <div class="grid grid-cols-12 gap-4 h-[90vh]">
        <!-- Sidebar -->
        <div class="col-span-3 terminal-border p-4 overflow-y-auto bg-black">
            <p class="text-[10px] opacity-50 mb-4">> NODE_LIST</p>
            <div id="guildList" class="space-y-2"></div>
        </div>

        <!-- Terminal -->
        <div class="col-span-9 flex flex-col gap-4">
            <div class="flex-1 terminal-border bg-black flex flex-col overflow-hidden">
                <div class="bg-[#00ff41] text-black text-[10px] px-2 py-1 flex justify-between font-bold">
                    <span>NEURAL_CONSO_STREAM.EXE</span>
                    <span id="nodeName">AWAITING_UPLINK...</span>
                </div>
                <div id="conOut" class="flex-1 p-4 overflow-y-auto text-xs space-y-1">
                    <p class="opacity-40">> discGPT Neural Link v2.5 initialized.</p>
                </div>
                <div class="p-3 border-t border-[#00ff41] flex gap-2">
                    <span class="font-bold">></span>
                    <input type="text" id="conIn" class="flex-1 bg-transparent outline-none" placeholder="Type 'help'..." onkeydown="if(event.key==='Enter') sendCmd()">
                    <div class="cursor"></div>
                </div>
            </div>

            <div class="grid grid-cols-4 gap-4">
                <button onclick="sendRaw('help')" class="terminal-border p-2 text-[10px] hover:bg-[#00ff41] hover:text-black">PROTOCOLS</button>
                <button onclick="sendRaw('status')" class="terminal-border p-2 text-[10px] hover:bg-[#00ff41] hover:text-black">STATUS</button>
                <button onclick="document.getElementById('conOut').innerHTML=''" class="terminal-border p-2 text-[10px]">CLEAR</button>
                <a href="?logout=1" class="terminal-border p-2 text-[10px] text-red-500 text-center">EXIT</a>
            </div>
        </div>
    </div>

    <script>
        let curG = null;
        const KEY = "<?= $WEB_API_KEY ?>";

        async function loadGuilds() {
            const res = await fetch(`<?= $BOT_URL ?>/guilds?key=${KEY}`);
            const data = await res.json();
            const list = document.getElementById('guildList');
            list.innerHTML = "";
            data.forEach(g => {
                const d = document.createElement('div');
                d.className = "p-2 border border-[#00ff41]/20 cursor-pointer hover:bg-[#00ff41]/10 text-xs";
                d.onclick = () => { curG = g.id; document.getElementById('nodeName').innerText = g.name; log(`Link: ${g.name}`, 'cyan'); };
                d.innerText = `> ${g.name}`;
                list.appendChild(d);
            });
        }

        function log(t, c='#00ff41', type='SYS') {
            const o = document.getElementById('conOut');
            const p = document.createElement('div');
            p.className = `log-${type}`;
            p.style.color = c;
            p.innerText = `[${new Date().toLocaleTimeString()}] ${t}`;
            o.appendChild(p);
            o.scrollTop = o.scrollHeight;
        }

        async function pollLogs() {
            if(!curG) return;
            const res = await fetch(`<?= $BOT_URL ?>/logs/${curG}?key=${KEY}`);
            const logs = await res.json();
            logs.slice(-5).forEach(l => {
                if(!document.getElementById(`l-${l.id}`)) {
                    const d = document.createElement('div');
                    d.id = `l-${l.id}`; d.className = `log-${l.type}`;
                    d.innerText = `[${l.time}] ${l.content}`;
                    document.getElementById('conOut').appendChild(d);
                    document.getElementById('conOut').scrollTop = 99999;
                }
            });
        }

        function sendRaw(v) { document.getElementById('conIn').value = v; sendCmd(); }

        async function sendCmd() {
            const i = document.getElementById('conIn');
            const v = i.value; i.value = "";
            if(v === 'help') {
                log("--- PROTOCOLS ---", "white");
                ["ban [id]", "kick [id]", "mute [id]", "purge [count]", "lock [id]", "unlock [id]", "nick [name]", "status", "info"].forEach(c => log("  " + c, "#888"));
                return;
            }
            if(!curG) return log("ERR: SELECT NODE", "red");
            log(`EXEC: ${v}`, "yellow");
            const res = await fetch(`<?= $BOT_URL ?>/console/exec`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({key: KEY, cmd: v, guildId: curG})
            });
            const d = await res.json();
            if(d.success) log("OK: " + d.success);
            if(d.error) log("ERR: " + d.error, "red");
        }

        loadGuilds();
        setInterval(pollLogs, 2000);
    </script>
<?php endif; ?>
</body>
</html>
